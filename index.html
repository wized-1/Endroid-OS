<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endroid OS - Chrome OS Desktop</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- JSZip for EPK extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.4/firebase-auth-compat.js"></script>
</head>
<body>
    <!-- Desktop Background -->
    <div id="background"></div>
    
    <!-- Desktop Area -->
    <div id="desktop">
        <div class="desktop-icons-grid" id="desktop-icons"></div>
        <!-- Snap zones -->
        <div class="window-snap-zone snap-left" data-snap="left"></div>
        <div class="window-snap-zone snap-right" data-snap="right"></div>
        <div class="window-snap-zone snap-top" data-snap="top"></div>
        <div class="window-snap-zone snap-bottom" data-snap="bottom"></div>
        <div class="window-snap-zone snap-full" data-snap="full"></div>
    </div>
    
    <!-- Shelf/Taskbar -->
    <div id="shelf">
        <button id="app-launcher" title="App Launcher">
            <span class="material-icons">apps</span>
        </button>
        
        <div id="workspace-indicator" class="workspace-indicator" title="Workspace 1">
            <span class="material-icons">grid_view</span>
            <span class="workspace-number">1</span>
        </div>
        
        <div id="taskbar"></div>
        
        <div id="system-tray">
            <div class="network-indicator" title="Network">
                <span class="material-icons">wifi</span>
            </div>
            
            <div class="battery-indicator" title="Battery">
                <span class="material-icons battery-icon">battery_full</span>
                <span class="battery-level">100%</span>
            </div>
            
            <div class="system-icon" id="quick-settings-btn" title="Quick Settings">
                <span class="material-icons">tune</span>
            </div>
            
            <div class="system-icon" id="notifications-btn" title="Notifications">
                <span class="material-icons">notifications</span>
                <div class="notification-badge" id="notification-badge" style="display: none;"></div>
            </div>
            
            <div class="system-icon" id="account-btn" title="Account">
                <div id="account-avatar" class="user-avatar">
                    <span class="material-icons">account_circle</span>
                </div>
            </div>
            
            <div id="clock" title="Click for calendar">10:00 AM</div>
        </div>
    </div>

    <!-- UI Components -->
    <div class="notifications-panel" id="notifications-panel" style="display: none;"></div>
    <div class="quick-settings-panel" id="quick-settings-panel" style="display: none;"></div>
    <div class="app-launcher-modal" id="app-launcher-modal" style="display: none;"></div>
    <div class="shortcuts-modal" id="shortcuts-modal" style="display: none;"></div>
    <div class="performance-monitor" id="performance-monitor" style="display: none;"></div>
    <div class="spotlight-search" id="spotlight-search" style="display: none;"></div>
    <div class="welcome-tour" id="welcome-tour" style="display: none;"></div>
    <div class="context-menu" id="context-menu" style="display: none;"></div>

    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
            --primary: #4285f4;
            --primary-dark: #3367d6;
            --primary-light: #8ab4f8;
            --primary-rgb: 66, 133, 244;
            --surface: #ffffff;
            --surface-dark: #202124;
            --surface-light: #f8f9fa;
            --surface-card: rgba(255, 255, 255, 0.95);
            --on-surface: #202124;
            --on-surface-light: #5f6368;
            --on-surface-dark: #e8eaed;
            --border: #dadce0;
            --success: #34a853;
            --error: #ea4335;
            --warning: #fbbc04;
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 16px;
            --elevation-1: 0 1px 2px rgba(0,0,0,0.05);
            --elevation-2: 0 4px 12px rgba(0,0,0,0.1);
            --elevation-3: 0 8px 24px rgba(0,0,0,0.15);
            --transition: 0.2s ease;
        }

        .dark-mode {
            --surface: #202124;
            --surface-card: rgba(32, 33, 36, 0.95);
            --surface-light: #2d2e31;
            --on-surface: #e8eaed;
            --on-surface-light: #9aa0a6;
            --border: #5f6368;
            --elevation-1: 0 1px 2px rgba(0,0,0,0.2);
            --elevation-2: 0 4px 12px rgba(0,0,0,0.3);
            --elevation-3: 0 8px 24px rgba(0,0,0,0.4);
        }

        /* ===== BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            overflow: hidden;
            background: var(--surface);
            color: var(--on-surface);
            font-size: 14px;
            line-height: 1.5;
            user-select: none;
        }

        /* ===== BACKGROUND ===== */
        #background {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;
            background-position: center;
            z-index: 1;
            transition: background-image 0.5s ease;
        }

        #background::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.1) 100%);
        }

        /* ===== DESKTOP ===== */
        #desktop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 56px;
            overflow: auto;
            padding: 20px;
            z-index: 2;
        }

        .desktop-icons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            grid-auto-rows: minmax(90px, auto);
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px 8px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition);
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            min-width: 80px;
            max-width: 90px;
            text-align: center;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: var(--elevation-2);
        }

        .desktop-icon .material-icons {
            font-size: 40px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: var(--border-radius-sm);
            color: var(--primary);
        }

        .desktop-icon span {
            font-size: 12px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            white-space: nowrap;
        }

        /* ===== WINDOWS ===== */
        .window {
            position: absolute;
            background: var(--surface-card);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--elevation-3);
            min-width: 400px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            resize: both;
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 96px);
            z-index: 100;
        }

        .window.active {
            border-color: var(--primary);
            box-shadow: var(--elevation-3), 0 0 0 2px var(--primary);
            z-index: 200;
        }

        .window.maximized {
            width: calc(100vw - 40px) !important;
            height: calc(100vh - 96px) !important;
            top: 20px !important;
            left: 20px !important;
            resize: none;
        }

        .window.minimized {
            display: none;
        }

        .title-bar {
            height: 40px;
            background: var(--surface-light);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            cursor: move;
            user-select: none;
        }

        .window-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .title-text {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: var(--on-surface);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .window-controls {
            display: flex;
            gap: 4px;
        }

        .win-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
            color: var(--on-surface-light);
        }

        .win-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        .dark-mode .win-btn:hover {
            background: rgba(255,255,255,0.05);
        }

        .win-btn.close:hover {
            background: var(--error);
            color: white;
        }

        .window-content {
            flex: 1;
            overflow: hidden;
            background: var(--surface);
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* ===== SHELF/TASKBAR ===== */
        #shelf {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }

        .dark-mode #shelf {
            background: rgba(32, 33, 36, 0.9);
            border-color: rgba(255,255,255,0.1);
        }

        #app-launcher {
            width: 48px;
            height: 48px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition);
            margin-right: 16px;
            box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3);
        }

        #app-launcher:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        #taskbar {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            overflow-x: auto;
            padding: 0 10px;
        }

        #taskbar::-webkit-scrollbar {
            display: none;
        }

        .taskbar-item {
            position: relative;
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition);
            background: transparent;
        }

        .taskbar-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .dark-mode .taskbar-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .taskbar-item.active {
            background: rgba(var(--primary-rgb), 0.1);
        }

        .taskbar-item.active::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }

        .taskbar-item .material-icons {
            font-size: 24px;
            color: var(--on-surface-light);
        }

        .taskbar-item.active .material-icons {
            color: var(--primary);
        }

        #system-tray {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .system-icon {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background var(--transition);
        }

        .system-icon:hover {
            background: rgba(0,0,0,0.05);
        }

        .dark-mode .system-icon:hover {
            background: rgba(255,255,255,0.05);
        }

        .system-icon .material-icons {
            font-size: 20px;
            color: var(--on-surface-light);
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: var(--error);
            border-radius: 50%;
            border: 2px solid var(--surface);
        }

        .dark-mode .notification-badge {
            border-color: var(--surface-dark);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 14px;
            border: 2px solid var(--surface);
        }

        .dark-mode .user-avatar {
            border-color: var(--surface-dark);
        }

        #clock {
            font-size: 14px;
            font-weight: 500;
            color: var(--on-surface);
            margin-left: 16px;
            white-space: nowrap;
            padding: 8px 12px;
            background: rgba(0,0,0,0.03);
            border-radius: var(--border-radius-sm);
            min-width: 80px;
            text-align: center;
        }

        .dark-mode #clock {
            background: rgba(255,255,255,0.05);
        }

        /* ===== NOTIFICATIONS PANEL ===== */
        .notifications-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 56px;
            width: 380px;
            background: var(--surface-card);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--border);
            z-index: 2001;
            display: flex;
            flex-direction: column;
        }

        .notifications-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--on-surface);
        }

        .notifications-toolbar {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            background: var(--surface-light);
        }

        .notifications-toolbar-btn {
            padding: 6px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-sm);
            color: var(--on-surface);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .notifications-toolbar-btn:hover {
            background: var(--surface-light);
            border-color: var(--primary);
        }

        .notifications-toolbar-btn.clear-all {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        .notifications-toolbar-btn.clear-all:hover {
            background: #c5221f;
        }

        .notifications-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .notification-item {
            background: var(--surface-light);
            border-radius: var(--border-radius-sm);
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary);
            position: relative;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-item.error {
            border-left-color: var(--error);
        }

        .notification-item.success {
            border-left-color: var(--success);
        }

        .notification-item.warning {
            border-left-color: var(--warning);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 8px;
        }

        .notification-title {
            font-weight: 500;
            color: var(--on-surface);
            font-size: 14px;
            flex: 1;
        }

        .notification-time {
            font-size: 12px;
            color: var(--on-surface-light);
            white-space: nowrap;
        }

        .notification-message {
            font-size: 13px;
            color: var(--on-surface-light);
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .notification-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }

        .notification-action-btn {
            padding: 4px 8px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-sm);
            color: var(--on-surface-light);
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .notification-action-btn:hover {
            background: var(--surface-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .notification-close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--on-surface-light);
            opacity: 0;
            transition: all var(--transition);
        }

        .notification-item:hover .notification-close-btn {
            opacity: 1;
        }

        .notification-close-btn:hover {
            background: rgba(0,0,0,0.05);
            color: var(--error);
        }

        .dark-mode .notification-close-btn:hover {
            background: rgba(255,255,255,0.05);
        }

        .notifications-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--on-surface-light);
        }

        .notifications-empty .material-icons {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Quick Settings */
        .quick-settings-panel {
            position: fixed;
            bottom: 60px;
            right: 20px;
            width: 300px;
            background: var(--surface-card);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            box-shadow: var(--elevation-3);
            z-index: 2001;
            border: 1px solid var(--border);
        }

        .quick-settings-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 20px;
        }

        .quick-setting-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all var(--transition);
            background: var(--surface-light);
            text-align: center;
        }

        .quick-setting-item:hover {
            background: var(--surface);
            transform: scale(1.05);
        }

        .quick-setting-item.active {
            background: rgba(var(--primary-rgb), 0.1);
            color: var(--primary);
        }

        .quick-setting-item .material-icons {
            font-size: 24px;
            margin-bottom: 8px;
        }

        /* App Launcher */
        .app-launcher-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 700px;
            height: 500px;
            max-width: 90vw;
            max-height: 80vh;
            background: var(--surface-card);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            box-shadow: var(--elevation-3);
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }

        .app-launcher-search {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .app-launcher-search input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--border-radius-sm);
            background: var(--surface);
            color: var(--on-surface);
            font-size: 16px;
            outline: none;
        }

        .app-launcher-search input:focus {
            border-color: var(--primary);
        }

        .app-launcher-grid {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
        }

        .app-launcher-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all var(--transition);
            background: var(--surface-light);
            text-align: center;
        }

        .app-launcher-item:hover {
            background: var(--surface);
            transform: translateY(-2px);
            box-shadow: var(--elevation-2);
        }

        .app-launcher-item .material-icons {
            font-size: 48px;
            margin-bottom: 12px;
            color: var(--primary);
        }

        .app-launcher-item span {
            font-size: 13px;
            font-weight: 500;
            color: var(--on-surface);
        }

        /* Spotlight Search */
        .spotlight-search {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            max-width: 90%;
            background: var(--surface-card);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            box-shadow: var(--elevation-3);
            z-index: 3000;
        }

        .spotlight-input {
            width: 100%;
            padding: 20px;
            border: none;
            background: transparent;
            color: var(--on-surface);
            font-size: 20px;
            outline: none;
        }

        .spotlight-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .spotlight-result {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background var(--transition);
            border-top: 1px solid var(--border);
        }

        .spotlight-result:hover {
            background: var(--surface-light);
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--surface-card);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--elevation-3);
            z-index: 3000;
            min-width: 200px;
            border: 1px solid var(--border);
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background var(--transition);
            border-bottom: 1px solid var(--border);
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background: var(--surface-light);
        }

        /* Welcome Tour */
        .welcome-tour {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tour-card {
            background: var(--surface-card);
            border-radius: var(--border-radius);
            padding: 32px;
            max-width: 500px;
            text-align: center;
        }

        /* Snap Zones */
        .window-snap-zone {
            position: fixed;
            z-index: 999;
            background: rgba(var(--primary-rgb), 0.1);
            border: 2px dashed var(--primary);
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition);
        }

        .window-snap-zone.visible {
            opacity: 1;
            pointer-events: all;
        }

        .snap-left {
            left: 20px;
            top: 20px;
            bottom: 76px;
            width: calc(50% - 30px);
        }

        .snap-right {
            right: 20px;
            top: 20px;
            bottom: 76px;
            width: calc(50% - 30px);
        }

        .snap-top {
            left: 20px;
            right: 20px;
            top: 20px;
            height: calc(50% - 48px);
        }

        .snap-bottom {
            left: 20px;
            right: 20px;
            bottom: 76px;
            height: calc(50% - 48px);
        }

        .snap-full {
            left: 20px;
            right: 20px;
            top: 20px;
            bottom: 76px;
        }

        /* App Installer */
        .app-installer-content {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .app-installer-tabs {
            display: flex;
            background: var(--surface-light);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
        }

        .app-installer-tab {
            padding: 16px 24px;
            cursor: pointer;
            font-weight: 500;
            color: var(--on-surface-light);
            border-bottom: 2px solid transparent;
            transition: all var(--transition);
        }

        .app-installer-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .app-installer-tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .app-installer-section {
            background: var(--surface-light);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--border-radius-sm);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition);
        }

        .drop-zone:hover {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.05);
        }

        .progress-container {
            background: var(--surface-light);
            border-radius: var(--border-radius-sm);
            padding: 16px;
            margin: 16px 0;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        .custom-apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .custom-app-card {
            background: var(--surface-light);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all var(--transition);
            border: 1px solid var(--border);
        }

        .custom-app-card:hover {
            background: var(--surface);
            border-color: var(--primary);
        }

        .custom-app-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius-sm);
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .custom-app-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--on-surface);
            text-align: center;
        }

        /* System Indicators */
        .workspace-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(var(--primary-rgb), 0.1);
            border-radius: var(--border-radius-sm);
            margin-right: 16px;
        }

        .network-indicator,
        .battery-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(0,0,0,0.03);
            border-radius: var(--border-radius-sm);
        }

        .dark-mode .network-indicator,
        .dark-mode .battery-indicator {
            background: rgba(255,255,255,0.05);
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            backdrop-filter: blur(5px);
        }

        /* Utility Classes */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            transition: all var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--on-surface);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Hide scrollbars but allow scrolling */
        .app-launcher-grid::-webkit-scrollbar,
        .notifications-content::-webkit-scrollbar,
        .spotlight-results::-webkit-scrollbar {
            width: 6px;
        }

        .app-launcher-grid::-webkit-scrollbar-track,
        .notifications-content::-webkit-scrollbar-track,
        .spotlight-results::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 3px;
        }

        .dark-mode .app-launcher-grid::-webkit-scrollbar-track,
        .dark-mode .notifications-content::-webkit-scrollbar-track,
        .dark-mode .spotlight-results::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }

        .app-launcher-grid::-webkit-scrollbar-thumb,
        .notifications-content::-webkit-scrollbar-thumb,
        .spotlight-results::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        .dark-mode .app-launcher-grid::-webkit-scrollbar-thumb,
        .dark-mode .notifications-content::-webkit-scrollbar-thumb,
        .dark-mode .spotlight-results::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
        }
    </style>

    <script>
        // ===== CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCK4ehah9mZ9h8PWtDXOrEJqdEcNefGGtY",
            authDomain: "endroid-search.firebaseapp.com",
            projectId: "endroid-search",
            storageBucket: "endroid-search.firebasestorage.app",
            messagingSenderId: "36139140746",
            appId: "1:36139140746:web:ca9c3ce0065998eda28f73",
            measurementId: "G-5KY8LBYL8P"
        };

        // Initialize Firebase
        let firebaseApp, firebaseAuth;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            firebaseAuth = firebase.auth();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // Apps configuration
        const apps = [
            {
                id: 'chrome',
                name: 'Chrome',
                url: ''https://www.google.com/webhp?igu=1',
                icon: 'language',
                taskbar: true,
                desktop: true
            },
            {
                id: 'calculator',
                name: 'Calculator',
                url: 'https://wized2.github.io/Calculator',
                icon: 'calculate',
                taskbar: true,
                desktop: true
            },
            {
                id: 'clock',
                name: 'Clock',
                url: 'https://wized2.github.io/Clock/',
                icon: 'schedule',
                taskbar: true,
                desktop: true
            },
            {
                id: 'notes',
                name: 'Notes',
                url: 'https://wized2.github.io/Notes/',
                icon: 'note',
                taskbar: true,
                desktop: true
            },
            {
                id: 'calendar',
                name: 'Calendar',
                url: 'https://calendar.google.com/calendar/embed?src=f5a7ee6f7cffe3a8e9bc82fb25507fa5ffa332d2b03d0412c4f7c32e6f07a129%40group.calendar.google.com&ctz=Asia%2FKarachi',
                icon: 'calendar_today',
                taskbar: true,
                desktop: true
            },
            {
                id: 'music',
                name: 'Music',
                url: 'https://wized2.github.io/Music/',
                icon: 'music_note',
                taskbar: true,
                desktop: true
            },
            {
                id: 'app-installer',
                name: 'App Store',
                url: '#app-installer',
                icon: 'install_desktop',
                taskbar: true,
                desktop: true
            }
        ];

        const wallpapers = [
            'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80',
            'https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80'
        ];

        // ===== STATE MANAGEMENT =====
        const windows = new Map();
        const taskbarItems = new Map();
        const desktopIcons = new Map();
        const notifications = [];
        let windowZIndex = 100;
        let activeWindow = null;
        let currentUser = null;
        let selectedIcon = null;
        let isDraggingWindow = false;
        let snapTarget = null;
        let isTakingScreenshot = false;
        
        let settings = {
            theme: 'light',
            backgroundUrl: wallpapers[0],
            snapWindows: true,
            notifications: true
        };

        // ===== UTILITY FUNCTIONS =====
        function createModalOverlay() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            return overlay;
        }

        function showNotification(message, isError = false, onlyToast = false) {
            if (!onlyToast) {
                // Create notification
                const notification = {
                    id: Date.now(),
                    title: isError ? 'Error' : 'Notification',
                    message: message,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    type: isError ? 'error' : 'info'
                };
                
                notifications.unshift(notification);
                
                // Update badge
                updateNotificationBadge();
                
                // Update notifications panel if open
                if (document.getElementById('notifications-panel').style.display === 'flex') {
                    updateNotificationsPanel();
                }
            }
            
            // Show toast
            const toast = document.createElement('div');
            toast.className = 'notification-item ' + (isError ? 'error' : 'info');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isError ? 'var(--error)' : 'var(--primary)'};
                color: white;
                padding: 12px 20px;
                border-radius: var(--border-radius-sm);
                box-shadow: var(--elevation-2);
                z-index: 3000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
            
            // Add CSS for animations
            if (!document.querySelector('#notification-animations')) {
                const style = document.createElement('style');
                style.id = 'notification-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (badge) {
                badge.style.display = notifications.length > 0 ? 'block' : 'none';
            }
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('endroid-settings');
                if (saved) {
                    Object.assign(settings, JSON.parse(saved));
                }
                applySettings();
            } catch (e) {
                console.error('Error loading settings:', e);
            }
        }

        function saveSettings() {
            try {
                localStorage.setItem('endroid-settings', JSON.stringify(settings));
            } catch (e) {
                console.error('Error saving settings:', e);
            }
        }

        function applySettings() {
            // Apply theme
            document.body.className = settings.theme === 'dark' ? 'dark-mode' : 'light-mode';
            
            // Apply background
            const background = document.getElementById('background');
            if (settings.backgroundUrl) {
                background.style.backgroundImage = `url('${settings.backgroundUrl}')`;
            }
        }

        // ===== NOTIFICATION FUNCTIONS =====
        function addNotification(title, message, type = 'info') {
            const notification = {
                id: Date.now(),
                title: title,
                message: message,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                type: type
            };
            
            notifications.unshift(notification);
            updateNotificationBadge();
            
            // Update panel if open
            if (document.getElementById('notifications-panel').style.display === 'flex') {
                updateNotificationsPanel();
            }
        }

        function clearNotification(id) {
            const index = notifications.findIndex(n => n.id === id);
            if (index !== -1) {
                notifications.splice(index, 1);
                updateNotificationBadge();
                
                // Update panel if open
                if (document.getElementById('notifications-panel').style.display === 'flex') {
                    updateNotificationsPanel();
                }
                
                return true;
            }
            return false;
        }

        function clearAllNotifications() {
            if (notifications.length === 0) return;
            
            notifications.length = 0;
            updateNotificationBadge();
            
            // Update panel if open
            if (document.getElementById('notifications-panel').style.display === 'flex') {
                updateNotificationsPanel();
            }
            
            showNotification('All notifications cleared', false, true);
        }

        function updateNotificationsPanel() {
            const panel = document.getElementById('notifications-panel');
            const emptyState = notifications.length === 0;
            
            panel.innerHTML = `
                <div class="notifications-header">
                    <div class="notifications-title">Notifications</div>
                    <button class="win-btn close" style="background: transparent; border: none; cursor: pointer;">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                
                ${!emptyState ? `
                    <div class="notifications-toolbar">
                        <button class="notifications-toolbar-btn clear-all" id="clear-all-notifications">
                            <span class="material-icons" style="font-size: 14px;">delete_sweep</span>
                            Clear All
                        </button>
                    </div>
                ` : ''}
                
                <div class="notifications-content">
                    ${emptyState ? `
                        <div class="notifications-empty">
                            <span class="material-icons">notifications_none</span>
                            <p>No new notifications</p>
                        </div>
                    ` : notifications.map(notif => `
                        <div class="notification-item ${notif.type}" data-notification-id="${notif.id}">
                            <button class="notification-close-btn" title="Clear this notification">
                                <span class="material-icons">close</span>
                            </button>
                            <div class="notification-header">
                                <div class="notification-title">${notif.title}</div>
                                <div class="notification-time">${notif.time}</div>
                            </div>
                            <div class="notification-message">${notif.message}</div>
                            <div class="notification-actions">
                                <button class="notification-action-btn" onclick="clearNotification(${notif.id})">
                                    Clear
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Add event listeners
            panel.querySelector('.win-btn.close').addEventListener('click', () => {
                panel.style.display = 'none';
                document.removeEventListener('click', closeNotificationsOutside);
            });
            
            if (!emptyState) {
                // Clear all button
                panel.querySelector('#clear-all-notifications').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (notifications.length > 0) {
                        clearAllNotifications();
                    }
                });
                
                // Individual clear buttons
                panel.querySelectorAll('.notification-close-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const notificationItem = e.target.closest('.notification-item');
                        const notificationId = parseInt(notificationItem.dataset.notificationId);
                        clearNotification(notificationId);
                    });
                });
            }
        }

        function initNotifications() {
            const panel = document.getElementById('notifications-panel');
            const btn = document.getElementById('notifications-btn');
            
            if (!panel || !btn) return;
            
            let isOpen = false;
            
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                isOpen = !isOpen;
                panel.style.display = isOpen ? 'flex' : 'none';
                
                // Mark as read (clear badge)
                const badge = document.getElementById('notification-badge');
                if (badge) {
                    badge.style.display = 'none';
                }
                
                if (isOpen) {
                    updateNotificationsPanel();
                    setTimeout(() => document.addEventListener('click', closeNotificationsOutside), 100);
                } else {
                    document.removeEventListener('click', closeNotificationsOutside);
                }
            });
            
            function closeNotificationsOutside(e) {
                if (!panel.contains(e.target) && e.target !== btn) {
                    isOpen = false;
                    panel.style.display = 'none';
                    document.removeEventListener('click', closeNotificationsOutside);
                }
            }
            
            // Add sample notifications
            setTimeout(() => {
                addNotification('Welcome to Endroid OS', 'Your desktop is ready. Click icons to launch apps.', 'success');
                addNotification('System Update Available', 'Update to version 2.0 is ready to install.', 'info');
                addNotification('Storage Warning', 'Your storage is 85% full. Consider cleaning up.', 'warning');
            }, 1000);
        }

        // ===== WINDOW MANAGEMENT =====
        function createWindow(app) {
            const windowId = `window_${app.id}_${Date.now()}`;
            const window = document.createElement('div');
            window.className = 'window';
            window.id = windowId;
            window.dataset.appId = app.id;
            window.dataset.windowId = windowId;
            
            // Position window
            const offset = windows.size * 30;
            window.style.left = `${50 + offset}px`;
            window.style.top = `${50 + offset}px`;
            window.style.width = '800px';
            window.style.height = '600px';
            window.style.zIndex = windowZIndex++;
            
            window.innerHTML = `
                <div class="title-bar">
                    <div class="window-icon">
                        <span class="material-icons">${app.icon}</span>
                    </div>
                    <span class="title-text">${app.name}</span>
                    <div class="window-controls">
                        <button class="win-btn minimize" title="Minimize">
                            <span class="material-icons">minimize</span>
                        </button>
                        <button class="win-btn maximize" title="Maximize">
                            <span class="material-icons">crop_square</span>
                        </button>
                        <button class="win-btn close" title="Close">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                </div>
                <div class="window-content">
                    <iframe src="${app.url}" title="${app.name}" sandbox="allow-same-origin allow-scripts"></iframe>
                </div>
            `;
            
            // Make draggable
            makeDraggable(window, window.querySelector('.title-bar'));
            
            // Window controls
            window.querySelector('.minimize').addEventListener('click', () => minimizeWindow(window));
            window.querySelector('.maximize').addEventListener('click', () => toggleMaximize(window));
            window.querySelector('.close').addEventListener('click', () => closeWindow(window));
            
            window.addEventListener('mousedown', () => bringToFront(window));
            
            return window;
        }

        function makeDraggable(window, handle) {
            let isDragging = false;
            let startX, startY, startLeft, startTop;
            
            handle.addEventListener('mousedown', startDrag);
            
            function startDrag(e) {
                if (e.target.closest('.win-btn')) return;
                
                isDragging = true;
                isDraggingWindow = true;
                bringToFront(window);
                
                const rect = window.getBoundingClientRect();
                startX = e.clientX;
                startY = e.clientY;
                startLeft = rect.left;
                startTop = rect.top;
                
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
            }
            
            function drag(e) {
                if (!isDragging) return;
                
                const newX = startLeft + (e.clientX - startX);
                const newY = startTop + (e.clientY - startY);
                
                // Boundary checking
                const desktop = document.getElementById('desktop');
                const maxX = desktop.clientWidth - window.clientWidth;
                const maxY = desktop.clientHeight - window.clientHeight;
                
                window.style.left = `${Math.max(0, Math.min(newX, maxX))}px`;
                window.style.top = `${Math.max(0, Math.min(newY, maxY))}px`;
                
                // Show snap zones
                if (settings.snapWindows) {
                    checkSnapZones(e.clientX, e.clientY, window);
                }
            }
            
            function stopDrag() {
                isDragging = false;
                isDraggingWindow = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
                
                // Hide snap zones
                document.querySelectorAll('.window-snap-zone').forEach(zone => {
                    zone.classList.remove('visible');
                });
                
                // Snap if needed
                if (snapTarget) {
                    snapWindow(window, snapTarget);
                    snapTarget = null;
                }
            }
        }

        function minimizeWindow(window) {
            window.classList.add('minimized');
            const appId = window.dataset.appId;
            const taskbarItem = taskbarItems.get(appId);
            if (taskbarItem) {
                taskbarItem.item.classList.remove('active');
            }
        }

        function toggleMaximize(window) {
            window.classList.toggle('maximized');
            const icon = window.querySelector('.maximize .material-icons');
            icon.textContent = window.classList.contains('maximized') ? 'filter_none' : 'crop_square';
        }

        function closeWindow(window) {
            const windowId = window.dataset.windowId;
            const appId = window.dataset.appId;
            
            // Remove from windows map
            windows.delete(windowId);
            
            // Remove from taskbar if no other windows of this app are open
            const hasOtherWindows = Array.from(windows.values()).some(w => 
                w.dataset.appId === appId && w.dataset.windowId !== windowId
            );
            
            if (!hasOtherWindows) {
                const taskbarItem = taskbarItems.get(appId);
                if (taskbarItem) {
                    taskbarItem.item.remove();
                    taskbarItems.delete(appId);
                }
            }
            
            window.remove();
            
            if (activeWindow === window) {
                activeWindow = null;
            }
        }

        function bringToFront(window) {
            window.style.zIndex = windowZIndex++;
            setActiveWindow(window);
        }

        function setActiveWindow(window) {
            if (activeWindow) {
                activeWindow.classList.remove('active');
            }
            
            window.classList.add('active');
            activeWindow = window;
            
            // Update taskbar
            const appId = window.dataset.appId;
            const taskbarItem = taskbarItems.get(appId);
            if (taskbarItem) {
                taskbarItem.item.classList.add('active');
            }
        }

        // ===== DESKTOP ICONS =====
        function createDesktopIcons() {
            const container = document.getElementById('desktop-icons');
            container.innerHTML = '';
            
            // Built-in apps
            apps.forEach(app => {
                if (app.desktop) {
                    const icon = createDesktopIcon(app);
                    container.appendChild(icon);
                    desktopIcons.set(app.id, icon);
                }
            });
            
            // Custom apps
            const customApps = JSON.parse(localStorage.getItem('endroid-custom-apps') || '[]');
            customApps.forEach(app => {
                const appConfig = {
                    id: app.id,
                    name: app.name,
                    icon: app.icon,
                    desktop: true,
                    custom: true,
                    data: app
                };
                
                const icon = createDesktopIcon(appConfig);
                container.appendChild(icon);
                desktopIcons.set(app.id, icon);
            });
        }

        function createDesktopIcon(app) {
            const icon = document.createElement('div');
            icon.className = 'desktop-icon';
            icon.dataset.appId = app.id;
            icon.title = app.name;
            
            const iconHTML = app.custom ? 
                `<span class="material-icons">${app.icon || 'apps'}</span>` :
                `<span class="material-icons">${app.icon}</span>`;
            
            icon.innerHTML = `
                ${iconHTML}
                <span>${app.name}</span>
            `;
            
            icon.addEventListener('click', (e) => {
                e.stopPropagation();
                openApp(app);
            });
            
            return icon;
        }

        // ===== TASKBAR =====
        function createTaskbarItem(app, window) {
            const taskbar = document.getElementById('taskbar');
            
            // Check if taskbar item already exists for this app
            if (taskbarItems.has(app.id)) {
                return taskbarItems.get(app.id).item;
            }
            
            const item = document.createElement('div');
            item.className = 'taskbar-item';
            item.dataset.appId = app.id;
            item.title = app.name;
            
            item.innerHTML = `<span class="material-icons">${app.icon}</span>`;
            
            item.addEventListener('click', () => {
                if (window.classList.contains('minimized')) {
                    window.classList.remove('minimized');
                    bringToFront(window);
                } else if (window === activeWindow) {
                    minimizeWindow(window);
                } else {
                    bringToFront(window);
                }
            });
            
            taskbar.appendChild(item);
            taskbarItems.set(app.id, { item, window });
            
            return item;
        }

        // ===== APP MANAGEMENT =====
        function openApp(app) {
            // Special handling for App Installer
            if (app.id === 'app-installer') {
                let existingWindow = null;
                // Check if app installer is already open
                for (const [windowId, window] of windows) {
                    if (window.dataset.appId === 'app-installer') {
                        existingWindow = window;
                        break;
                    }
                }
                
                if (!existingWindow) {
                    existingWindow = createWindow(app);
                    windows.set(existingWindow.dataset.windowId, existingWindow);
                    document.getElementById('desktop').appendChild(existingWindow);
                    createTaskbarItem(app, existingWindow);
                    initializeAppInstaller(existingWindow);
                }
                bringToFront(existingWindow);
                if (existingWindow.classList.contains('minimized')) {
                    existingWindow.classList.remove('minimized');
                }
                return existingWindow;
            }
            
            // Custom apps
            if (app.custom) {
                return launchCustomApp(app.data || app);
            }
            
            // Regular apps - create new window for each instance
            const windowId = `window_${app.id}_${Date.now()}`;
            const window = createWindow(app);
            window.dataset.windowId = windowId;
            windows.set(windowId, window);
            document.getElementById('desktop').appendChild(window);
            createTaskbarItem(app, window);
            
            setActiveWindow(window);
            return window;
        }

        // ===== APP INSTALLER =====
        function initializeAppInstaller(window) {
            const content = window.querySelector('.window-content');
            content.innerHTML = '';
            
            const installerContent = document.createElement('div');
            installerContent.className = 'app-installer-content';
            installerContent.innerHTML = `
                <div class="app-installer-tabs">
                    <div class="app-installer-tab active" data-tab="install">Install</div>
                    <div class="app-installer-tab" data-tab="installed">My Apps</div>
                </div>
                
                <div class="app-installer-tab-content">
                    <div id="tab-install" class="tab-content">
                        <div class="app-installer-section">
                            <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                                <span class="material-icons">cloud_upload</span>
                                Install EPK Package
                            </h3>
                            <div class="drop-zone" id="epk-drop-zone">
                                <span class="material-icons" style="font-size: 48px; margin-bottom: 16px; color: var(--on-surface-light);">upload_file</span>
                                <h4 style="margin-bottom: 8px;">Drag & drop your .epk file here</h4>
                                <p style="margin-bottom: 20px; color: var(--on-surface-light);">or click to browse files</p>
                                <button id="browse-epk-btn" class="btn btn-primary">
                                    <span class="material-icons">folder_open</span>
                                    Browse Files
                                </button>
                                <input type="file" id="epk-file-input" accept=".epk" hidden>
                            </div>
                            <div id="installation-progress" style="display: none;"></div>
                        </div>
                        
                        <div class="app-installer-section">
                            <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                                <span class="material-icons">help</span>
                                How to Create EPK Files
                            </h3>
                            <div style="color: var(--on-surface-light); line-height: 1.6;">
                                <p>1. Create your app files (HTML, CSS, JS)</p>
                                <p>2. Create a manifest.json file</p>
                                <p>3. Compress all files to .zip</p>
                                <p>4. Rename .zip to .epk</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-installed" class="tab-content" style="display: none;">
                        <div class="app-installer-section">
                            <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                                <span class="material-icons">apps</span>
                                Installed Applications
                            </h3>
                            <div id="custom-apps-list" class="custom-apps-grid">
                                <!-- Apps will be loaded here -->
                            </div>
                            <div id="no-custom-apps" style="text-align: center; padding: 40px 20px; color: var(--on-surface-light);">
                                <span class="material-icons" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">inbox</span>
                                <p>No apps installed yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            content.appendChild(installerContent);
            
            // Setup event listeners
            setupAppInstallerEvents();
            loadInstalledApps();
        }

        function setupAppInstallerEvents() {
            // Tab switching
            document.querySelectorAll('.app-installer-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    document.querySelectorAll('.app-installer-tab, .tab-content').forEach(el => {
                        el.classList.remove('active');
                        if (el.classList.contains('tab-content')) {
                            el.style.display = 'none';
                        }
                    });
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    const tabId = tab.dataset.tab;
                    const content = document.getElementById(`tab-${tabId}`);
                    if (content) {
                        content.classList.add('active');
                        content.style.display = 'block';
                    }
                });
            });
            
            // File drop zone
            const dropZone = document.getElementById('epk-drop-zone');
            const fileInput = document.getElementById('epk-file-input');
            const browseBtn = document.getElementById('browse-epk-btn');
            
            if (dropZone && browseBtn && fileInput) {
                browseBtn.addEventListener('click', () => fileInput.click());
                
                dropZone.addEventListener('click', () => fileInput.click());
                
                ['dragover', 'dragleave', 'drop'].forEach(event => {
                    dropZone.addEventListener(event, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
                
                dropZone.addEventListener('dragover', () => {
                    dropZone.style.borderColor = 'var(--primary)';
                    dropZone.style.background = 'rgba(var(--primary-rgb), 0.05)';
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.borderColor = 'var(--border)';
                    dropZone.style.background = '';
                });
                
                dropZone.addEventListener('drop', (e) => {
                    dropZone.style.borderColor = 'var(--border)';
                    dropZone.style.background = '';
                    
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.epk')) {
                        installEPK(file);
                    } else {
                        showNotification('Please select a .epk file', true, true);
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && file.name.endsWith('.epk')) {
                        installEPK(file);
                    }
                });
            }
        }

        async function installEPK(file) {
            const progressDiv = document.getElementById('installation-progress');
            if (!progressDiv) return;
            
            progressDiv.style.display = 'block';
            progressDiv.innerHTML = `
                <div class="progress-container">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Installing ${file.name}</span>
                        <span>0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                </div>
            `;
            
            const progressFill = progressDiv.querySelector('.progress-fill');
            const progressPercent = progressDiv.querySelector('span:last-child');
            
            try {
                // Update progress
                progressFill.style.width = '30%';
                progressPercent.textContent = '30%';
                
                // Read file
                const buffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(buffer);
                
                // Update progress
                progressFill.style.width = '60%';
                progressPercent.textContent = '60%';
                
                // Read manifest
                const manifestFile = zip.file("manifest.json");
                if (!manifestFile) throw new Error("manifest.json not found");
                
                const manifestContent = await manifestFile.async("text");
                const manifest = JSON.parse(manifestContent);
                
                // Validate required fields
                if (!manifest.name || !manifest.id || !manifest.icon) {
                    throw new Error("Invalid manifest.json");
                }
                
                // Check if app exists
                const existingApps = JSON.parse(localStorage.getItem('endroid-custom-apps') || '[]');
                if (existingApps.some(app => app.id === manifest.id)) {
                    throw new Error(`App "${manifest.name}" already installed`);
                }
                
                // Update progress
                progressFill.style.width = '90%';
                progressPercent.textContent = '90%';
                
                // Extract all files
                const appFiles = {};
                for (const filename in zip.files) {
                    const entry = zip.files[filename];
                    if (!entry.dir) {
                        const content = await entry.async("text");
                        appFiles[filename] = content;
                    }
                }
                
                // Save app
                const appData = {
                    id: manifest.id,
                    name: manifest.name,
                    icon: manifest.icon,
                    files: appFiles,
                    manifest: manifest,
                    installedDate: new Date().toISOString(),
                    version: manifest.version || '1.0.0'
                };
                
                existingApps.push(appData);
                localStorage.setItem('endroid-custom-apps', JSON.stringify(existingApps));
                
                // Complete
                progressFill.style.width = '100%';
                progressPercent.textContent = '100%';
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    progressDiv.innerHTML = '';
                    loadInstalledApps();
                    createDesktopIcons();
                    showNotification(`"${manifest.name}" installed successfully!`, false, true);
                }, 1000);
                
            } catch (error) {
                progressDiv.style.display = 'none';
                showNotification(`Installation failed: ${error.message}`, true, true);
            }
        }

        function loadInstalledApps() {
            const container = document.getElementById('custom-apps-list');
            const noApps = document.getElementById('no-custom-apps');
            const apps = JSON.parse(localStorage.getItem('endroid-custom-apps') || '[]');
            
            if (!container || !noApps) return;
            
            if (apps.length === 0) {
                container.innerHTML = '';
                noApps.style.display = 'block';
                return;
            }
            
            noApps.style.display = 'none';
            container.innerHTML = apps.map((app, index) => `
                <div class="custom-app-card" data-app-id="${app.id}">
                    <div class="custom-app-icon">
                        <span class="material-icons">${app.icon || 'apps'}</span>
                    </div>
                    <div class="custom-app-name">${app.name}</div>
                    <button class="uninstall-btn" data-index="${index}" style="
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        background: var(--error);
                        border: none;
                        color: white;
                        cursor: pointer;
                        display: none;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        font-weight: bold;
                    "></button>
                </div>
            `).join('');
            
            // Add hover effect for uninstall button
            container.querySelectorAll('.custom-app-card').forEach(card => {
                const uninstallBtn = card.querySelector('.uninstall-btn');
                
                card.addEventListener('mouseenter', () => {
                    uninstallBtn.style.display = 'flex';
                });
                
                card.addEventListener('mouseleave', () => {
                    uninstallBtn.style.display = 'none';
                });
                
                // Click to launch app
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.uninstall-btn')) {
                        const appId = card.dataset.appId;
                        const app = apps.find(a => a.id === appId);
                        if (app) launchCustomApp(app);
                    }
                });
                
                // Uninstall button
                uninstallBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(uninstallBtn.dataset.index);
                    uninstallApp(index);
                });
            });
        }

        function launchCustomApp(app) {
            const windowId = `custom-${app.id}-${Date.now()}`;
            let window = windows.get(windowId);
            
            if (!window) {
                window = document.createElement('div');
                window.className = 'window';
                window.id = windowId;
                window.dataset.appId = app.id;
                window.dataset.custom = 'true';
                window.dataset.windowId = windowId;
                
                window.style.left = '100px';
                window.style.top = '100px';
                window.style.width = '800px';
                window.style.height = '600px';
                window.style.zIndex = windowZIndex++;
                
                window.innerHTML = `
                    <div class="title-bar">
                        <div class="window-icon">
                            <span class="material-icons">${app.icon || 'apps'}</span>
                        </div>
                        <span class="title-text">${app.name}</span>
                        <div class="window-controls">
                            <button class="win-btn minimize"><span class="material-icons">minimize</span></button>
                            <button class="win-btn maximize"><span class="material-icons">crop_square</span></button>
                            <button class="win-btn close"><span class="material-icons">close</span></button>
                        </div>
                    </div>
                    <div class="window-content">
                        <div style="padding: 20px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                            <span class="material-icons" style="font-size: 64px; color: var(--primary); margin-bottom: 20px;">${app.icon || 'apps'}</span>
                            <h2 style="margin-bottom: 10px;">${app.name}</h2>
                            <p style="color: var(--on-surface-light); margin-bottom: 20px;">${app.manifest?.description || 'Custom Application'}</p>
                            <p style="font-size: 12px; color: var(--on-surface-light);">Version ${app.version || '1.0.0'}</p>
                        </div>
                    </div>
                `;
                
                // Make draggable
                makeDraggable(window, window.querySelector('.title-bar'));
                
                // Window controls
                window.querySelector('.minimize').addEventListener('click', () => minimizeWindow(window));
                window.querySelector('.maximize').addEventListener('click', () => toggleMaximize(window));
                window.querySelector('.close').addEventListener('click', () => closeWindow(window));
                
                window.addEventListener('mousedown', () => bringToFront(window));
                
                document.getElementById('desktop').appendChild(window);
                windows.set(windowId, window);
                
                // Create taskbar item
                const appConfig = {
                    id: app.id,
                    name: app.name,
                    icon: app.icon || 'apps'
                };
                createTaskbarItem(appConfig, window);
            }
            
            bringToFront(window);
            if (window.classList.contains('minimized')) {
                window.classList.remove('minimized');
            }
            setActiveWindow(window);
        }

        function uninstallApp(index) {
            const apps = JSON.parse(localStorage.getItem('endroid-custom-apps') || '[]');
            const app = apps[index];
            
            if (confirm(`Uninstall "${app.name}"?`)) {
                apps.splice(index, 1);
                localStorage.setItem('endroid-custom-apps', JSON.stringify(apps));
                
                // Close all windows of this app
                for (const [windowId, window] of windows) {
                    if (window.dataset.appId === app.id && window.dataset.custom === 'true') {
                        closeWindow(window);
                    }
                }
                
                // Update UI
                loadInstalledApps();
                createDesktopIcons();
                showNotification(`"${app.name}" uninstalled`, false, true);
            }
        }

        // ===== WINDOW SNAPPING =====
        function checkSnapZones(x, y, window) {
            const zones = document.querySelectorAll('.window-snap-zone');
            let foundZone = false;
            
            zones.forEach(zone => {
                const rect = zone.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    zone.classList.add('visible');
                    snapTarget = zone.dataset.snap;
                    foundZone = true;
                } else {
                    zone.classList.remove('visible');
                }
            });
            
            if (!foundZone) {
                snapTarget = null;
            }
        }

        function snapWindow(window, position) {
            const desktop = document.getElementById('desktop');
            const desktopRect = desktop.getBoundingClientRect();
            
            switch(position) {
                case 'left':
                    window.style.left = '20px';
                    window.style.top = '20px';
                    window.style.width = `calc(50% - 30px)`;
                    window.style.height = `calc(100% - 96px)`;
                    break;
                case 'right':
                    window.style.left = `calc(50% + 10px)`;
                    window.style.top = '20px';
                    window.style.width = `calc(50% - 30px)`;
                    window.style.height = `calc(100% - 96px)`;
                    break;
                case 'top':
                    window.style.left = '20px';
                    window.style.top = '20px';
                    window.style.width = `calc(100% - 40px)`;
                    window.style.height = `calc(50% - 48px)`;
                    break;
                case 'bottom':
                    window.style.left = '20px';
                    window.style.top = `calc(50% + 28px)`;
                    window.style.width = `calc(100% - 40px)`;
                    window.style.height = `calc(50% - 48px)`;
                    break;
                case 'full':
                    toggleMaximize(window);
                    break;
            }
            
            showNotification(`Window snapped ${position}`, false, true);
        }

        // ===== SYSTEM COMPONENTS =====
        function initQuickSettings() {
            const panel = document.getElementById('quick-settings-panel');
            const btn = document.getElementById('quick-settings-btn');
            
            if (!panel || !btn) return;
            
            let isOpen = false;
            
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                isOpen = !isOpen;
                panel.style.display = isOpen ? 'block' : 'none';
                
                if (isOpen) {
                    updateQuickSettings();
                    setTimeout(() => document.addEventListener('click', closeQuickSettingsOutside), 100);
                } else {
                    document.removeEventListener('click', closeQuickSettingsOutside);
                }
            });
            
            function closeQuickSettingsOutside(e) {
                if (!panel.contains(e.target) && e.target !== btn) {
                    isOpen = false;
                    panel.style.display = 'none';
                    document.removeEventListener('click', closeQuickSettingsOutside);
                }
            }
            
            function updateQuickSettings() {
                panel.innerHTML = `
                    <div class="quick-settings-grid">
                        <div class="quick-setting-item ${settings.theme === 'dark' ? 'active' : ''}" data-setting="theme">
                            <span class="material-icons">${settings.theme === 'dark' ? 'dark_mode' : 'light_mode'}</span>
                            <span>${settings.theme === 'dark' ? 'Dark' : 'Light'}</span>
                        </div>
                        <div class="quick-setting-item" data-setting="wifi">
                            <span class="material-icons">wifi</span>
                            <span>Wi-Fi</span>
                        </div>
                        <div class="quick-setting-item" data-setting="bluetooth">
                            <span class="material-icons">bluetooth</span>
                            <span>Bluetooth</span>
                        </div>
                        <div class="quick-setting-item" data-setting="screenshot" onclick="takeScreenshot()">
                            <span class="material-icons">screenshot</span>
                            <span>Screenshot</span>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                panel.querySelectorAll('.quick-setting-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const setting = item.dataset.setting;
                        if (setting === 'theme') {
                            settings.theme = settings.theme === 'light' ? 'dark' : 'light';
                            applySettings();
                            saveSettings();
                            updateQuickSettings();
                            showNotification(`Theme changed to ${settings.theme}`, false, true);
                        }
                    });
                });
            }
        }

        function initAppLauncher() {
            const modal = document.getElementById('app-launcher-modal');
            const btn = document.getElementById('app-launcher');
            
            if (!modal || !btn) return;
            
            let isOpen = false;
            
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                isOpen = !isOpen;
                modal.style.display = isOpen ? 'flex' : 'none';
                
                if (isOpen) {
                    updateAppLauncher();
                    setTimeout(() => document.addEventListener('click', closeAppLauncherOutside), 100);
                } else {
                    document.removeEventListener('click', closeAppLauncherOutside);
                }
            });
            
            function closeAppLauncherOutside(e) {
                if (!modal.contains(e.target) && e.target !== btn) {
                    isOpen = false;
                    modal.style.display = 'none';
                    document.removeEventListener('click', closeAppLauncherOutside);
                }
            }
            
            function updateAppLauncher() {
                // Get all apps
                const allApps = [...apps];
                const customApps = JSON.parse(localStorage.getItem('endroid-custom-apps') || '[]');
                customApps.forEach(app => {
                    allApps.push({
                        id: app.id,
                        name: app.name,
                        icon: app.icon || 'apps',
                        custom: true,
                        data: app
                    });
                });
                
                modal.innerHTML = `
                    <div style="width: 100%; height: 100%; display: flex; flex-direction: column;">
                        <div class="app-launcher-search">
                            <input type="text" placeholder="Search apps..." id="app-search-input">
                        </div>
                        <div class="app-launcher-grid" id="app-launcher-grid">
                            ${allApps.map(app => `
                                <div class="app-launcher-item" data-app-id="${app.id}">
                                    <span class="material-icons">${app.icon}</span>
                                    <span>${app.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // Add click handlers
                modal.querySelectorAll('.app-launcher-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const appId = item.dataset.appId;
                        const app = allApps.find(a => a.id === appId);
                        if (app) {
                            openApp(app);
                            modal.style.display = 'none';
                            isOpen = false;
                            document.removeEventListener('click', closeAppLauncherOutside);
                        }
                    });
                });
                
                // Search functionality
                const searchInput = document.getElementById('app-search-input');
                const appGrid = document.getElementById('app-launcher-grid');
                
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const items = appGrid.querySelectorAll('.app-launcher-item');
                    
                    items.forEach(item => {
                        const appName = item.querySelector('span:last-child').textContent.toLowerCase();
                        if (appName.includes(query)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
                
                // Focus search input
                searchInput.focus();
            }
        }

        function initSpotlightSearch() {
            const modal = document.getElementById('spotlight-search');
            
            if (!modal) return;
            
            // Open with Ctrl+Space
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === ' ') {
                    e.preventDefault();
                    toggleSpotlight();
                }
                if (e.key === 'Escape' && modal.style.display === 'block') {
                    modal.style.display = 'none';
                }
            });
            
            let isOpen = false;
            
            function toggleSpotlight() {
                isOpen = !isOpen;
                modal.style.display = isOpen ? 'block' : 'none';
                
                if (isOpen) {
                    updateSpotlight();
                    setTimeout(() => {
                        modal.querySelector('input').focus();
                        document.addEventListener('click', closeSpotlightOutside);
                    }, 100);
                } else {
                    document.removeEventListener('click', closeSpotlightOutside);
                }
            }
            
            function closeSpotlightOutside(e) {
                if (!modal.contains(e.target)) {
                    isOpen = false;
                    modal.style.display = 'none';
                    document.removeEventListener('click', closeSpotlightOutside);
                }
            }
            
            function updateSpotlight() {
                // Get all apps
                const allApps = [...apps];
                const customApps = JSON.parse(localStorage.getItem('endroid-custom-apps') || '[]');
                customApps.forEach(app => {
                    allApps.push({
                        id: app.id,
                        name: app.name,
                        icon: app.icon || 'apps',
                        custom: true,
                        data: app
                    });
                });
                
                modal.innerHTML = `
                    <input type="text" class="spotlight-input" placeholder="Type to search..." id="spotlight-input">
                    <div class="spotlight-results" id="spotlight-results">
                        ${allApps.slice(0, 10).map(app => `
                            <div class="spotlight-result" data-app-id="${app.id}">
                                <span class="material-icons">${app.icon}</span>
                                <div>
                                    <div>${app.name}</div>
                                    <small style="color: var(--on-surface-light); font-size: 12px;">Application</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Add click handlers
                modal.querySelectorAll('.spotlight-result').forEach(result => {
                    result.addEventListener('click', () => {
                        const appId = result.dataset.appId;
                        const app = allApps.find(a => a.id === appId);
                        if (app) {
                            openApp(app);
                            modal.style.display = 'none';
                            isOpen = false;
                        }
                    });
                });
                
                // Search functionality
                const input = document.getElementById('spotlight-input');
                const results = document.getElementById('spotlight-results');
                
                input.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const filteredApps = allApps.filter(app => 
                        app.name.toLowerCase().includes(query)
                    );
                    
                    results.innerHTML = filteredApps.slice(0, 10).map(app => `
                        <div class="spotlight-result" data-app-id="${app.id}">
                            <span class="material-icons">${app.icon}</span>
                            <div>
                                <div>${app.name}</div>
                                <small style="color: var(--on-surface-light); font-size: 12px;">Application</small>
                            </div>
                        </div>
                    `).join('');
                    
                    // Re-add click handlers
                    results.querySelectorAll('.spotlight-result').forEach(result => {
                        result.addEventListener('click', () => {
                            const appId = result.dataset.appId;
                            const app = filteredApps.find(a => a.id === appId);
                            if (app) {
                                openApp(app);
                                modal.style.display = 'none';
                                isOpen = false;
                            }
                        });
                    });
                });
                
                // Enter key to open first result
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const firstResult = results.querySelector('.spotlight-result');
                        if (firstResult) {
                            const appId = firstResult.dataset.appId;
                            const app = allApps.find(a => a.id === appId);
                            if (app) {
                                openApp(app);
                                modal.style.display = 'none';
                                isOpen = false;
                            }
                        }
                    }
                });
            }
        }

        function initWelcomeTour() {
            const tour = document.getElementById('welcome-tour');
            
            if (!tour) return;
            
            // Check if tour was completed
            if (!localStorage.getItem('endroid-tour-completed')) {
                setTimeout(() => {
                    tour.style.display = 'flex';
                    showTourStep(0);
                }, 1000);
            }
            
            const steps = [
                {
                    title: "Welcome to Endroid OS",
                    message: "Your modern desktop experience is ready. Let's explore the main features.",
                    icon: "rocket_launch"
                },
                {
                    title: "App Launcher",
                    message: "Click the app icon in the shelf to open the app launcher and access all your applications.",
                    icon: "apps"
                },
                {
                    title: "Desktop Icons",
                    message: "Click any icon on the desktop to launch applications. Right-click for more options.",
                    icon: "desktop_windows"
                },
                {
                    title: "System Tray",
                    message: "Access notifications, quick settings, and your account from the system tray.",
                    icon: "settings"
                }
            ];
            
            let currentStep = 0;
            
            function showTourStep(step) {
                tour.innerHTML = `
                    <div class="tour-card">
                        <span class="material-icons" style="font-size: 48px; color: var(--primary); margin-bottom: 20px;">${steps[step].icon}</span>
                        <h2 style="margin-bottom: 16px;">${steps[step].title}</h2>
                        <p style="margin-bottom: 24px; color: var(--on-surface-light); line-height: 1.6;">${steps[step].message}</p>
                        <div style="display: flex; gap: 8px; margin-bottom: 24px; justify-content: center;">
                            ${steps.map((_, i) => `
                                <div class="tour-progress-dot ${i === step ? 'active' : ''}" style="
                                    width: 8px;
                                    height: 8px;
                                    border-radius: 50%;
                                    background: ${i === step ? 'var(--primary)' : 'var(--border)'};
                                "></div>
                            `).join('')}
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            ${step > 0 ? `
                                <button class="btn btn-secondary" id="tour-prev">Previous</button>
                            ` : ''}
                            <button class="btn btn-primary" id="tour-next">
                                ${step === steps.length - 1 ? 'Get Started' : 'Next'}
                            </button>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                const nextBtn = document.getElementById('tour-next');
                const prevBtn = document.getElementById('tour-prev');
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        if (step === steps.length - 1) {
                            tour.style.display = 'none';
                            localStorage.setItem('endroid-tour-completed', 'true');
                            showNotification('Welcome to Endroid OS!', false, true);
                        } else {
                            showTourStep(step + 1);
                        }
                    });
                }
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        showTourStep(step - 1);
                    });
                }
            }
        }

        function initContextMenu() {
            const menu = document.getElementById('context-menu');
            
            document.addEventListener('contextmenu', (e) => {
                if (e.target.closest('.window') || e.target.closest('#desktop')) {
                    e.preventDefault();
                    showContextMenu(e.clientX, e.clientY);
                }
            });
            
            function showContextMenu(x, y) {
                menu.style.left = `${x}px`;
                menu.style.top = `${y}px`;
                menu.style.display = 'block';
                
                menu.innerHTML = `
                    <div class="context-menu-item" id="refresh-desktop">
                        <span class="material-icons">refresh</span>
                        <span>Refresh</span>
                    </div>
                    <div class="context-menu-item" id="open-terminal">
                        <span class="material-icons">terminal</span>
                        <span>Open Terminal</span>
                    </div>
                    <div class="context-menu-item" id="open-settings">
                        <span class="material-icons">settings</span>
                        <span>Settings</span>
                    </div>
                    <div class="context-menu-item" id="change-wallpaper">
                        <span class="material-icons">wallpaper</span>
                        <span>Change Wallpaper</span>
                    </div>
                `;
                
                // Add event listeners
                document.getElementById('refresh-desktop').addEventListener('click', () => {
                    location.reload();
                });
                
                document.getElementById('open-terminal').addEventListener('click', () => {
                    showNotification('Terminal will be available in future updates', false, true);
                    menu.style.display = 'none';
                });
                
                document.getElementById('open-settings').addEventListener('click', () => {
                    showSettingsModal();
                    menu.style.display = 'none';
                });
                
                document.getElementById('change-wallpaper').addEventListener('click', () => {
                    changeWallpaper();
                    menu.style.display = 'none';
                });
                
                // Close on click outside
                setTimeout(() => {
                    const closeMenu = (e) => {
                        if (!menu.contains(e.target)) {
                            menu.style.display = 'none';
                            document.removeEventListener('click', closeMenu);
                        }
                    };
                    document.addEventListener('click', closeMenu);
                }, 100);
            }
        }

        // ===== SETTINGS MODAL =====
        function showSettingsModal() {
            const overlay = createModalOverlay();
            const modal = document.createElement('div');
            modal.className = 'settings-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 500px;
                max-width: 90%;
                max-height: 80vh;
                background: var(--surface-card);
                backdrop-filter: blur(20px);
                border-radius: var(--border-radius);
                box-shadow: var(--elevation-3);
                z-index: 2000;
                border: 1px solid var(--border);
                overflow: hidden;
            `;
            
            modal.innerHTML = `
                <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border);">
                    <div style="font-size: 18px; font-weight: 500; color: var(--on-surface); display: flex; align-items: center; gap: 10px;">
                        <span class="material-icons">settings</span>
                        Settings
                    </div>
                    <button class="win-btn close" style="background: transparent; border: none; cursor: pointer;">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="modal-content" style="padding: 20px; overflow-y: auto; max-height: 60vh;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--on-surface);">Theme</label>
                        <select id="theme-select" style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid var(--border);
                            border-radius: var(--border-radius-sm);
                            background: var(--surface);
                            color: var(--on-surface);
                        ">
                            <option value="light" ${settings.theme === 'light' ? 'selected' : ''}>Light</option>
                            <option value="dark" ${settings.theme === 'dark' ? 'selected' : ''}>Dark</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--on-surface);">Wallpaper</label>
                        <select id="wallpaper-select" style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid var(--border);
                            border-radius: var(--border-radius-sm);
                            background: var(--surface);
                            color: var(--on-surface);
                        ">
                            ${wallpapers.map((wp, i) => `
                                <option value="${wp}" ${settings.backgroundUrl === wp ? 'selected' : ''}>
                                    Wallpaper ${i + 1}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--on-surface);">Window Snapping</label>
                        <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleCheckbox('snap-windows')">
                            <div id="snap-windows" style="
                                width: 20px;
                                height: 20px;
                                border: 2px solid var(--border);
                                border-radius: 4px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                ${settings.snapWindows ? 'background: var(--primary); border-color: var(--primary);' : ''}
                            ">
                                ${settings.snapWindows ? '<span class="material-icons" style="font-size: 14px; color: white;">check</span>' : ''}
                            </div>
                            <span>Enable window snapping</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--on-surface);">Notifications</label>
                        <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleCheckbox('notifications')">
                            <div id="notifications" style="
                                width: 20px;
                                height: 20px;
                                border: 2px solid var(--border);
                                border-radius: 4px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                ${settings.notifications ? 'background: var(--primary); border-color: var(--primary);' : ''}
                            ">
                                ${settings.notifications ? '<span class="material-icons" style="font-size: 14px; color: white;">check</span>' : ''}
                            </div>
                            <span>Enable notifications</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px;">
                    <button class="btn btn-secondary" id="cancel-settings">Cancel</button>
                    <button class="btn btn-primary" id="save-settings">Save</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // Event listeners
            modal.querySelector('.win-btn.close').addEventListener('click', closeModal);
            modal.querySelector('#cancel-settings').addEventListener('click', closeModal);
            modal.querySelector('#save-settings').addEventListener('click', saveSettings);
            overlay.addEventListener('click', closeModal);
            
            function closeModal() {
                modal.remove();
                overlay.remove();
            }
            
            function saveSettings() {
                settings.theme = document.getElementById('theme-select').value;
                settings.backgroundUrl = document.getElementById('wallpaper-select').value;
                settings.snapWindows = document.getElementById('snap-windows').style.background.includes('var(--primary)');
                settings.notifications = document.getElementById('notifications').style.background.includes('var(--primary)');
                
                applySettings();
                saveSettings();
                closeModal();
                showNotification('Settings saved', false, true);
            }
            
            // Add toggle function to global scope
            window.toggleCheckbox = function(id) {
                const checkbox = document.getElementById(id);
                if (checkbox.style.background.includes('var(--primary)')) {
                    checkbox.style.background = '';
                    checkbox.style.borderColor = 'var(--border)';
                    checkbox.innerHTML = '';
                } else {
                    checkbox.style.background = 'var(--primary)';
                    checkbox.style.borderColor = 'var(--primary)';
                    checkbox.innerHTML = '<span class="material-icons" style="font-size: 14px; color: white;">check</span>';
                }
            };
        }

        function changeWallpaper() {
            const currentIndex = wallpapers.indexOf(settings.backgroundUrl);
            const nextIndex = (currentIndex + 1) % wallpapers.length;
            settings.backgroundUrl = wallpapers[nextIndex];
            applySettings();
            saveSettings();
            showNotification('Wallpaper changed', false, true);
        }

        function takeScreenshot() {
            if (isTakingScreenshot) return;
            isTakingScreenshot = true;
            
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                z-index: 9999;
                opacity: 0;
                pointer-events: none;
                animation: flash 0.5s ease;
            `;
            
            // Add flash animation
            if (!document.querySelector('#flash-animation')) {
                const style = document.createElement('style');
                style.id = 'flash-animation';
                style.textContent = `
                    @keyframes flash {
                        0% { opacity: 0; }
                        10% { opacity: 0.8; }
                        100% { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(flash);
            
            setTimeout(() => {
                flash.remove();
                // Only show toast notification, not add to notifications list
                showNotification('Screenshot saved to Pictures folder', false, true);
                isTakingScreenshot = false;
            }, 500);
        }

        // ===== CLOCK =====
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const clock = document.getElementById('clock');
            if (clock) {
                clock.textContent = timeString;
            }
        }

        // ===== ACCOUNT FUNCTIONS =====
        function initAccount() {
            const btn = document.getElementById('account-btn');
            
            if (!btn) return;
            
            btn.addEventListener('click', () => {
                showAccountModal();
            });
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('endroid-user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    updateUserDisplay();
                } catch (e) {
                    console.error('Error loading user:', e);
                }
            }
        }

        function updateUserDisplay() {
            const avatar = document.getElementById('account-avatar');
            if (!avatar) return;
            
            if (currentUser) {
                const initials = currentUser.displayName ? 
                    currentUser.displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 
                    'US';
                
                avatar.innerHTML = currentUser.photoURL ? 
                    `<img src="${currentUser.photoURL}" alt="${currentUser.displayName || 'User'}" style="width: 100%; height: 100%; object-fit: cover;">` :
                    `<span>${initials}</span>`;
            } else {
                avatar.innerHTML = '<span class="material-icons">account_circle</span>';
            }
        }

        async function signInWithGoogle() {
            try {
                if (!firebaseAuth) {
                    throw new Error('Firebase not initialized');
                }
                
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('profile');
                provider.addScope('email');
                
                const result = await firebaseAuth.signInWithPopup(provider);
                const user = result.user;
                
                currentUser = {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL
                };
                
                localStorage.setItem('endroid-user', JSON.stringify(currentUser));
                updateUserDisplay();
                
                showNotification(`Signed in as ${user.displayName || user.email}`, false, true);
                return true;
            } catch (error) {
                console.error('Google sign-in error:', error);
                
                // Fallback to demo user for testing
                currentUser = {
                    displayName: 'Demo User',
                    email: 'demo@example.com',
                    photoURL: null
                };
                localStorage.setItem('endroid-user', JSON.stringify(currentUser));
                updateUserDisplay();
                
                showNotification('Signed in as Demo User (Fallback mode)', false, true);
                return false;
            }
        }

        async function signOutUser() {
            try {
                if (firebaseAuth) {
                    await firebaseAuth.signOut();
                }
            } catch (error) {
                console.error('Sign out error:', error);
            }
            
            currentUser = null;
            localStorage.removeItem('endroid-user');
            updateUserDisplay();
            showNotification('Signed out', false, true);
        }

        function showAccountModal() {
            const overlay = createModalOverlay();
            const modal = document.createElement('div');
            modal.className = 'account-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 400px;
                max-width: 90%;
                background: var(--surface-card);
                backdrop-filter: blur(20px);
                border-radius: var(--border-radius);
                box-shadow: var(--elevation-3);
                z-index: 2000;
                border: 1px solid var(--border);
                overflow: hidden;
            `;
            
            if (currentUser) {
                modal.innerHTML = `
                    <div style="padding: 24px; text-align: center; border-bottom: 1px solid var(--border);">
                        <div style="font-size: 20px; font-weight: 500; margin-bottom: 8px; color: var(--on-surface);">Account</div>
                        <div style="color: var(--on-surface-light); font-size: 14px;">${currentUser.email}</div>
                    </div>
                    <div style="padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 500; font-size: 20px;">
                                ${currentUser.photoURL ? 
                                    `<img src="${currentUser.photoURL}" alt="${currentUser.displayName}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                    `<span>${currentUser.displayName ? currentUser.displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'US'}</span>`
                                }
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 500; color: var(--on-surface); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${currentUser.displayName || 'User'}</div>
                                <div style="font-size: 14px; color: var(--on-surface-light); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${currentUser.email}</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="signout-btn" style="width: 100%;">
                            <span class="material-icons">logout</span>
                            Sign Out
                        </button>
                    </div>
                `;
            } else {
                modal.innerHTML = `
                    <div style="padding: 24px; text-align: center; border-bottom: 1px solid var(--border);">
                        <div style="font-size: 20px; font-weight: 500; margin-bottom: 8px; color: var(--on-surface);">Sign In</div>
                        <div style="color: var(--on-surface-light); font-size: 14px;">Access your saved settings</div>
                    </div>
                    <div style="padding: 24px;">
                        <button class="btn btn-primary" id="google-signin-btn" style="width: 100%; margin-bottom: 12px;">
                            <span class="material-icons">login</span>
                            Sign in with Google
                        </button>
                        <button class="btn btn-secondary" id="guest-btn" style="width: 100%;">
                            <span class="material-icons">person</span>
                            Continue as Guest
                        </button>
                    </div>
                `;
            }
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // Close button
            const closeBtn = document.createElement('button');
            closeBtn.className = 'win-btn close';
            closeBtn.style.cssText = 'position: absolute; top: 10px; right: 10px; background: transparent; border: none; cursor: pointer;';
            closeBtn.innerHTML = '<span class="material-icons">close</span>';
            closeBtn.addEventListener('click', () => {
                modal.remove();
                overlay.remove();
            });
            modal.appendChild(closeBtn);
            
            // Event listeners
            if (currentUser) {
                modal.querySelector('#signout-btn').addEventListener('click', async () => {
                    await signOutUser();
                    modal.remove();
                    overlay.remove();
                });
            } else {
                modal.querySelector('#google-signin-btn').addEventListener('click', async () => {
                    await signInWithGoogle();
                    modal.remove();
                    overlay.remove();
                });
                
                modal.querySelector('#guest-btn').addEventListener('click', () => {
                    modal.remove();
                    overlay.remove();
                    showNotification('Continuing as guest', false, true);
                });
            }
            
            overlay.addEventListener('click', () => {
                modal.remove();
                overlay.remove();
            });
        }

        // ===== KEYBOARD SHORTCUTS =====
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Alt+Tab - Switch windows
                if (e.altKey && e.key === 'Tab') {
                    e.preventDefault();
                    const windowArray = Array.from(windows.values());
                    if (windowArray.length > 0) {
                        const currentIndex = windowArray.indexOf(activeWindow);
                        const nextIndex = (currentIndex + 1) % windowArray.length;
                        bringToFront(windowArray[nextIndex]);
                    }
                }
                
                // Win+D - Show desktop (minimize all)
                if ((e.metaKey || e.ctrlKey) && e.key === 'd') {
                    e.preventDefault();
                    windows.forEach(window => {
                        minimizeWindow(window);
                    });
                }
                
                // Win+S - Screenshot
                if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                    e.preventDefault();
                    takeScreenshot();
                }
                
                // Win+L - Lock (placeholder)
                if ((e.metaKey || e.ctrlKey) && e.key === 'l') {
                    e.preventDefault();
                    showNotification('Lock screen feature coming soon', false, true);
                }
                
                // Win+I - Settings
                if ((e.metaKey || e.ctrlKey) && e.key === 'i') {
                    e.preventDefault();
                    showSettingsModal();
                }
                
                // Win+A - App launcher
                if ((e.metaKey || e.ctrlKey) && e.key === 'a') {
                    e.preventDefault();
                    document.getElementById('app-launcher').click();
                }
            });
        }

        // ===== INITIALIZATION =====
        function init() {
            // Load settings
            loadSettings();
            
            // Initialize components
            createDesktopIcons();
            
            // Initialize system components
            initNotifications();
            initQuickSettings();
            initAppLauncher();
            initSpotlightSearch();
            initWelcomeTour();
            initContextMenu();
            initAccount();
            initKeyboardShortcuts();
            
            // Start clock
            updateClock();
            setInterval(updateClock, 60000);
            
            // Desktop click handler
            document.getElementById('desktop').addEventListener('click', (e) => {
                if (e.target === document.getElementById('desktop') || 
                    e.target.classList.contains('desktop-icons-grid')) {
                    // Lower all windows
                    windows.forEach(window => {
                        window.style.zIndex = 100;
                    });
                    windowZIndex = 200;
                    activeWindow = null;
                    
                    // Remove active state from taskbar
                    taskbarItems.forEach(item => {
                        item.item.classList.remove('active');
                    });
                }
            });
            
            // Add sample notifications
            setTimeout(() => {
                addNotification('Welcome to Endroid OS', 'Your desktop is ready. Click icons to launch apps.', 'success');
            }, 1000);
            
            // Show welcome message
            setTimeout(() => {
                if (!localStorage.getItem('endroid-tour-completed')) {
                    showNotification('Welcome to Endroid OS! Click the app launcher to get started.', false, true);
                }
            }, 1500);
        }

        // ===== GLOBAL FUNCTIONS =====
        // Make these functions available globally for inline event handlers
        window.clearNotification = clearNotification;
        window.clearAllNotifications = clearAllNotifications;
        window.takeScreenshot = takeScreenshot;
        window.showSettingsModal = showSettingsModal;
        window.changeWallpaper = changeWallpaper;
        window.signInWithGoogle = signInWithGoogle;

        // Start everything
        window.addEventListener('load', init);
    </script>
</body>
</html>
